---
title: "Spis treści"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
---

---
title: "Zaliczenie przedmiotu 'Wprowadzenie do języka SQL'"
subtitle: "Studia podyplomowe: 'Metody Statystycznej Analizy Danych - edycja IX'"
author: "Jędrzej Szelc"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

***

## Ćwiczenia z wykładów

### Konfiguracja wstępna

Poniżej zawarto funkcje pomocniczne do ćwiczeń z wykładów.

```{r wstepna konfiguracja do cwiczen}
##################################################
### Wstępna konfiguracja do ćwiczeń z wykładów ###
##################################################

### Funkcje pomocnicze

# Funkcja listująca 5 rzędów 'surveys'
query_5_su <- function(string_zapytanie_SQL)
{
  DBI::dbGetQuery(mammals, "SELECT * FROM surveys LIMIT 5")
}

# Funkcja listująca 5 rzędów 'plots'
query_5_pl <- function(string_zapytanie_SQL)
{
  DBI::dbGetQuery(mammals, "SELECT * FROM plots LIMIT 5")
}

# Funkcja listująca 5 rzędów 'species'
query_5_sp <- function(string_zapytanie_SQL)
{
  DBI::dbGetQuery(mammals, "SELECT * FROM species LIMIT 5")
}

# Funkcja odpytująca bazę danych 'mammals'
query_mammals <- function(string_zapytanie_SQL)
{
  DBI::dbGetQuery(mammals, string_zapytanie_SQL)
}

# Uniwersalna funkcja odpytująca dowolną bazę danych
query_any_DB <- function(obiekt_bazy_danych, string_zapytanie_SQL)
{
  DBI::dbGetQuery(obiekt_bazy_danych, string_zapytanie_SQL)
}
```

***

### Ćwiczenia z wykładu 2

Tytuł wykładu:

*"Tworzenie środowiska SQL w RStudio"*

***

#### Wykład 2 - Ćwiczenia numer 1, 2, 3

Oryginalna treść ćwiczeń:

*"1. Otwórz nowy projekt w RStudio."*

*"2. Utwórz nowy folder "data_raw"w folderze projektu."*

*"3. Pobierz plik ‘portal_mammals.sqlite‘ ze strony https://ndownloader.figshare.com/files/2292171 i zapisz w folderze ‘data_raw‘."*

Rozwiązanie ćwiczeń:

```{r wyklad_2_cwiczenia_1_2_3}
dir.create("data_raw", showWarnings = FALSE)

download.file(url = "https://ndownloader.figshare.com/files/2292171",
              destfile = "data_raw/portal_mammals.sqlite",
              mode = "wb")
```

***

#### Wykład 2 - Ćwiczenie numer 4

Oryginalna treść ćwiczenia:

*"Zaimportuj pakiet ‘DBI‘ i ustaw połączenie z bazą danych [według wskazówek podanych przez prowadzącego]."*

Rozwiązanie ćwiczenia:

```{r wyklad_2_cwiczenie_4}
library(DBI)

mammals <- DBI::dbConnect(RSQLite::SQLite(), "data_raw/portal_mammals.sqlite")
```

***

#### Wykład 2 - Ćwiczenie numer 5

Oryginalna treść ćwiczenia:

*"Wykonaj zapytanie SQL i wyświetl wynik: dbGetQuery(mammals, SELECT (wszystkie_kolumny) FROM surveys LIMIT 10)"*.

Rozwiązanie ćwiczenia:

```{r wyklad_2_cwiczenie_5}
wszystkie_kolumny_z_limitem_10_wierszy <- query_mammals("
  SELECT * 
  FROM surveys 
  LIMIT 10
  ")
wszystkie_kolumny_z_limitem_10_wierszy
```

***

### Ćwiczenia z wykładu 3

Tytuł wykładu:

*"SELECT FROM"*

***

#### Wykład 3 - Ćwiczenie numer 1

Oryginalna treść ćwiczenia:

*"Wybierz tylko kolumny ‘weight‘ i ‘sex‘ z tabeli ‘surveys‘."*

Rozwiązanie ćwiczenia:

```{r wyklad_3_cwiczenie_1}
kolumny_weight_sex_z_limitem_5_wierszy <- query_mammals("
  SELECT weight, sex 
  FROM surveys 
  LIMIT 5
  ")
kolumny_weight_sex_z_limitem_5_wierszy
```

***

#### Wykład 3 - Ćwiczenie numer 2

Oryginalna treść ćwiczenia:

*"Wybierz pierwsze 5 wierszy z tabeli ‘surveys‘, wykorzystując ‘LIMIT‘."*

Rozwiązanie ćwiczenia:

```{r wyklad_3_cwiczenie_2}
wszystkie_kolumny_z_limitem_5_wierszy <- query_mammals("
  SELECT *
  FROM surveys 
  LIMIT 5
  ")
wszystkie_kolumny_z_limitem_5_wierszy
```

***

#### Wykład 3 - Ćwiczenie numer 3

Oryginalna treść ćwiczenia:

*"Wybierz kolumny ‘species_id‘, ‘sex‘ i ‘plot_type‘ z tabel ‘surveys‘ i ‘plots‘, wykorzystując aliasy dla tabel i dla kolumn."*

Rozwiązanie ćwiczenia:

```{r wyklad_3_cwiczenie_3}

# Tabela "surveys"
kolumny_z_aliasami_oraz_limitem_5_wierszy_dla_surveys <- query_mammals("
  SELECT species_id AS alias_id, sex AS alias_se
  FROM surveys
  LIMIT 5
  ")
kolumny_z_aliasami_oraz_limitem_5_wierszy_dla_surveys

# Tabela "plots"
kolumny_z_aliasami_oraz_limitem_5_wierszy_dla_plots <- query_mammals("
  SELECT plot_type AS alias_pt
  FROM plots
  LIMIT 5
  ")
kolumny_z_aliasami_oraz_limitem_5_wierszy_dla_plots
```

***

### Ćwiczenia z wykładu 4

Tytuł wykładu:

*"Zapytania i flitrowanie"*

***

#### Wykład 4 - Ćwiczenie numer 1

Oryginalna treść ćwiczenia:

*"Znajdź liczbę rekordów w tabeli surveys, które odpowiadają gatunkowi Dipodomys merriami."*

Rozwiązanie ćwiczenia:

```{r wyklad_4_cwiczenie_1}
liczba_rekordow_gatunku_dipodomys_merriami <- query_mammals("
  SELECT COUNT(species_id)
  FROM surveys
  WHERE species_id LIKE 'DM'
  ")
liczba_rekordow_gatunku_dipodomys_merriami
```

***

#### Wykład 4 - Ćwiczenie numer 2

Oryginalna treść ćwiczenia:

*"Znajdź liczbę rekordów w tabeli surveys, które odpowiadają gatunkowi Dipodomys merriami i mają wartość M w kolumnie sex."*

Rozwiązanie ćwiczenia:

```{r wyklad_4_cwiczenie_2}
liczba_rekordow_gatunku_dipodomys_merriami_oraz_plec_M <- query_mammals("
  SELECT COUNT(species_id)
  FROM surveys
  WHERE species_id LIKE 'DM' AND sex = 'M'
  ")
liczba_rekordow_gatunku_dipodomys_merriami_oraz_plec_M
```

***

#### Wykład 4 - Ćwiczenie numer 3

Oryginalna treść ćwiczenia:

*"Znajdź liczbę rekordów w tabeli surveys, które odpowiadają gatunkowi Dipodomys merriami lub mają wartość F w kolumnie sex."*

Rozwiązanie ćwiczenia:

```{r wyklad_4_cwiczenie_3}
liczba_rekordow_gatunku_dipodomys_merriami_lub_plec_M <- query_mammals("
  SELECT COUNT(species_id)
  FROM surveys
  WHERE species_id LIKE 'DM' OR sex = 'F'
  ")
liczba_rekordow_gatunku_dipodomys_merriami_lub_plec_M
```

***

#### Wykład 4 - Ćwiczenie numer 4

Oryginalna treść ćwiczenia:

*"Znajdź liczbę rekordów w tabeli species, które odpowiadają gatunkom, których nazwy gatunków (kolumna species) zaczynają się na literę d."*

Rozwiązanie ćwiczenia:

```{r wyklad_4_cwiczenie_4}
liczba_rekordow_gatunkow_na_litere_d <- query_mammals("
  SELECT COUNT(species_id)
  FROM surveys
  WHERE species_id LIKE 'd%'
  ")
liczba_rekordow_gatunkow_na_litere_d
```

***

#### Wykład 4 - Ćwiczenie numer 5

Oryginalna treść ćwiczenia:

*"Znajdź liczbę rekordów w tabeli plots, które odpowiadają działkom typu Control."*

Rozwiązanie ćwiczenia:

```{r wyklad_4_cwiczenie_5}
liczba_rekordow_plot_type_typu_control <- query_mammals("
  SELECT COUNT(plot_type)
  FROM plots
  WHERE plot_type = 'Control'
  ")
liczba_rekordow_plot_type_typu_control
```

***

### Ćwiczenia z wykładu 5

Tytuł wykładu:

*"Agregacje w SQL"*

***

#### Wykład 5 - Ćwiczenie numer 1

Oryginalna treść ćwiczenia:

*"Wybierz średnią wagę gryzonia dla każdej działki z tabeli surveys."*

Rozwiązanie ćwiczenia:

```{r}
srednia_waga_gryzonia_dla_kazdej_dzialki <- query_mammals("
  SELECT plot_id AS dzialka, AVG(weight) AS srednia_waga
  FROM surveys
  GROUP BY plot_id
  ")
srednia_waga_gryzonia_dla_kazdej_dzialki
```

***

#### Wykład 5 - Ćwiczenie numer 2

Oryginalna treść ćwiczenia:

*"Wybierz tylko te gatunki, które występują na więcej niż 20 różnych działkach z tabeli surveys."*

Rozwiązanie ćwiczenia:

```{r}
gatunki_na_wiecej_niz_20_roznych_dzialkach <- query_mammals("
  SELECT species_id AS gatunek, COUNT(plot_id) AS dzialka
  FROM surveys
  GROUP BY gatunek
  HAVING dzialka > 20
  ")
gatunki_na_wiecej_niz_20_roznych_dzialkach
```

***

#### Wykład 5 - Ćwiczenie numer 3

Oryginalna treść ćwiczenia:

*"Wybierz największą wartość hindfoot_length i najmniejszą wartość weight dla każdej kombinacji pomiędzy gatunkiem a płcią z tabeli surveys."*

Rozwiązanie ćwiczenia:

```{r}
najdluzsza_stopa_oraz_najmniejsza_waga_dla_kazdej_kombinacji_gatunek_plec <- 
  query_mammals("
    SELECT 
    species_id AS gatunek, sex AS plec, MAX(hindfoot_length) AS najdluzsza_stopa, 
    MIN(weight) AS najmniejsza_waga
    FROM surveys
    GROUP BY species_id, sex
    HAVING plec NOT LIKE 'NA' AND najdluzsza_stopa NOT LIKE 'NA' 
    AND najmniejsza_waga NOT LIKE 'NA'
    ")
najdluzsza_stopa_oraz_najmniejsza_waga_dla_kazdej_kombinacji_gatunek_plec
```

***

### Ćwiczenia z wykładu 6

Tytuł wykładu:

*"Łączenie wewnętrzne w SQL"*

***

#### Wykład 6 - Ćwiczenie numer 1

Oryginalna treść ćwiczenia:

*"Złącz tabele surveys i species używając klucza species_id. Wybierz tylko kolumny record_id, species_id, genus oraz species."*

Rozwiązanie ćwiczenia:

```{r}
join_dla_tabele_surveys_species <- query_mammals("
  SELECT record_id, su.species_id, genus
  FROM surveys AS su
  JOIN species AS sp
  ON su.species_id = sp.species_id
  LIMIT 5
  ")
join_dla_tabele_surveys_species
```

***

#### Wykład 6 - Ćwiczenie numer 2

Oryginalna treść ćwiczenia:

*"Używając złączenia wewnętrznego, złącz tabele surveys i species w taki sposób, aby uzyskać wszystkie rekordy z tabeli surveys nawet jeśli nie mają odpowiednika w tabeli species. Wybierz kolumny record_id, species_id, genus i species."*

Rozwiązanie ćwiczenia:

```{r}
print("Komentarz do rozwiązania: W mojej ocenie, nie mogę spełnić wymogów zadania 6.2 stosując INNER JOIN. Z tego powodu, zmuszony jestem zastosować LEFT JOIN.")

left_join_tabele_surveys_species_z_limitem_10_wierszy <- query_mammals("
  SELECT record_id, su.species_id, genus, species
  FROM surveys AS su
  LEFT JOIN species AS sp
  ON su.species_id = sp.species_id
  LIMIT 10
  ")
left_join_tabele_surveys_species_z_limitem_10_wierszy
```

***

#### Wykład 6 - Ćwiczenie numer 3

Oryginalna treść ćwiczenia:

*"Złącz tabele surveys, species i plots w taki sposób, aby uzyskać informacje o pomiarach, gatunkach i działkach badawczych. Wybierz kolumny record_id, species_id, genus, species, plot_id i plot_type. Ogranicz wynik do rekordów z roku 2002."*

Rozwiązanie ćwiczenia:

```{r}
multiple_join_tabele_surveys_species_plot_dla_year_2002_z_limitem_10_wierszy <- query_mammals("
  SELECT su.record_id, su.species_id, genus, sp.species, su.plot_id, plot_type
  FROM surveys AS su
  JOIN species AS sp
  ON su.species_id = sp.species_id 
  JOIN plots AS pl
  ON su.plot_id = pl.plot_id
  WHERE su.year = 2002
  LIMIT 10 
  ")
multiple_join_tabele_surveys_species_plot_dla_year_2002_z_limitem_10_wierszy
```

***

#### Wykład 6 - Ćwiczenie numer 4

Oryginalna treść ćwiczenia:

*"Złącz tabele surveys, species i plots oraz wybierz tylko te rekordy, które mają plot_type równy ’Control’. Wybierz kolumny record_id, species_id, genus, species, plot_id i plot_type."*

Rozwiązanie ćwiczenia:

```{r}
multiple_join_tabele_surveys_species_plot_dla_plot_type_control_z_limitem_10_wierszy <- 
  query_mammals("
  SELECT su.record_id, su.species_id, genus, species, su.plot_id, plot_type
  FROM surveys AS su
  JOIN species AS sp
  ON su.species_id = sp.species_id
  JOIN plots AS pl
  ON su.plot_id = pl.plot_id
  WHERE pl.plot_type LIKE 'Control'
  LIMIT 10
  ")
multiple_join_tabele_surveys_species_plot_dla_plot_type_control_z_limitem_10_wierszy
```

***

### Ćwiczenia z wykładu 7

Tytuł wykładu:

*"Łączenie danych w SQL"*

***

#### Wykład 7 - Ćwiczenie numer 1

Oryginalna treść ćwiczenia:

*"Znajdź wszystkie rekordy z tabeli surveys, które zawierają informacje o gatunkach, których nie ma w tabeli species."*

Rozwiązanie ćwiczenia:

```{r}
rekordy_surveys_zawierajace_gatunki_ktorych_nie_ma_w_species_z_limitem_10_wierszy <- query_mammals("
  SELECT * 
  FROM surveys AS su
  LEFT JOIN species AS sp
  ON su.species_id = sp.species_id 
  WHERE sp.species_id IS NULL
  LIMIT 10
  ")
rekordy_surveys_zawierajace_gatunki_ktorych_nie_ma_w_species_z_limitem_10_wierszy
```

***

#### Wykład 7 - Ćwiczenie numer 2

Oryginalna treść ćwiczenia:

*"Wyświetl listę wszystkich osobników gatunku Dipodomys, które zostały zarejestrowane w latach 2000-2010."*

Rozwiązanie ćwiczenia:

```{r}
osobniki_gatunku_Dipodomys_zarejestrowane_w_latach_2000_2010 <- query_mammals("
  SELECT sp.genus, sp.species
  FROM species AS sp
  WHERE EXISTS
    (
      SELECT * 
      FROM surveys AS su
      WHERE sp.species_id = su.species_id AND sp.genus LIKE 'Dipodomys'
        AND EXISTS
          (
            SELECT *
            FROM surveys AS su
            WHERE su.year BETWEEN 2000 AND 2010
          )
    )
  ")
osobniki_gatunku_Dipodomys_zarejestrowane_w_latach_2000_2010
```

***

#### Wykład 7 - Ćwiczenie numer 3

Oryginalna treść ćwiczenia:

*"Znajdź wszystkie rekordy z tabeli surveys, które zawierają informacje o gatunkach, które nie zostały zarejestrowane w żadnym badaniu w tabeli plots."*

Rozwiązanie ćwiczenia:

```{r}
print("W moim odczuciu, zadanie jest nieprecyzyjnie sformułowane. Z tego powodu przedstawiam dwa możliwe rozwiązania.")
 
# Wersja 1. rozwiązania
rekordy_surveys_zawierajace_gatunki_niezarejestrowane_plots_wersja_1_z_limitem_10_wierszy <- query_mammals("
  SELECT *
  FROM surveys AS su
  WHERE EXISTS
    (
      SELECT *
      FROM plots AS pl
      WHERE su.plot_id != pl.plot_id
    )
  LIMIT 10
  ")
rekordy_surveys_zawierajace_gatunki_niezarejestrowane_plots_wersja_1_z_limitem_10_wierszy

# Wersja 2. rozwiązania
rekordy_surveys_zawierajace_gatunki_niezarejestrowane_plots_wersja_2_z_limitem_10_wierszy <- query_mammals("
  SELECT * 
  FROM surveys AS su
  LEFT JOIN plots AS pl
  ON su.plot_id = pl.plot_id 
  WHERE EXISTS
    (
      SELECT * 
      FROM species AS sp
      JOIN surveys AS su
      WHERE sp.species_id = su.species_id
    )
  AND EXISTS
    (
      SELECT * 
      FROM plots AS pl
      WHERE pl.plot_id IS NULL
    )
  LIMIT 10
  ")
rekordy_surveys_zawierajace_gatunki_niezarejestrowane_plots_wersja_2_z_limitem_10_wierszy
```

***

### Ćwiczenia z wykładu 8

Tytuł wykładu:

*"Subkwerendy w SQL"*

***

#### Wykład 8 - Ćwiczenie numer 1

Oryginalna treść ćwiczenia:

*"Wyświetl listę wszystkich gatunków, które występują tylko w badaniach przeprowadzonych w miejscu badawczym o numerze 1."*

Rozwiązanie ćwiczenia:

```{r}
gatunki_wystepujace_tylko_miejsce_badawcze_numer_1 <- query_mammals("
  SELECT DISTINCT(sp.species) AS gatunek, su.plot_id AS dzialka_badawcza
  FROM species AS sp
  JOIN surveys AS su
  ON sp.species_id = su.species_id
  WHERE su.plot_id = 1
")
gatunki_wystepujace_tylko_miejsce_badawcze_numer_1
```

***

#### Wykład 8 - Ćwiczenie numer 2

Oryginalna treść ćwiczenia:

*"Znajdź rok, w którym zarejestrowano najwięcej osobników gatunków zrodzaju Dipodomys."*

Rozwiązanie ćwiczenia:

```{r}
rok_rejestracji_najwiekszej_liczby_osobnikow_gatunku_Dipodomys <- query_mammals("
  SELECT rok_z_maksymalna_liczba_gatunkow
  FROM 
    (
      SELECT year AS rok_z_maksymalna_liczba_gatunkow, 
             MAX(unikalne_gatunki) AS maksymalna_liczba_gatunkow_Dipodomys
      FROM 
        (SELECT year,
          COUNT(DISTINCT species_id) AS unikalne_gatunki
        FROM
          (SELECT su.species_id,
            su.year
            FROM surveys AS su
            JOIN species AS sp
            ON su.species_id = sp.species_id
            WHERE sp.genus = 'Dipodomys'
          )
        GROUP BY year)
    )
  ")
rok_rejestracji_najwiekszej_liczby_osobnikow_gatunku_Dipodomys
```

***

#### Wykład 8 - Ćwiczenie numer 3

Oryginalna treść ćwiczenia:

*"Wyświetl listę wszystkich gatunków, które zostały zarejestrowane co najmniej dwa razy w danym roku, razem z liczbą miejsc badawczych, w których zostały zarejestrowane."*

Rozwiązanie ćwiczenia:

```{r}
liczba_wszystkich_gatunkow_zarejestrowanych_2x_rok_liczba_miejsc_badawczych <- query_mammals("
  SELECT zbior_koncowy.species_id, 
         zbior_koncowy.wystapienia_w_danym_roku, 
         COUNT(plots.plot_id) AS liczba_miejsc_badawczych
    FROM plots
    JOIN 
    (
      SELECT zbior_gatunkow.species_id, zbior_gatunkow.wystapienia_w_danym_roku
      FROM (
            SELECT species_id, COUNT(DISTINCT(year)) AS wystapienia_w_danym_roku
            FROM surveys
            GROUP BY species_id
            ) AS zbior_gatunkow
      WHERE zbior_gatunkow.wystapienia_w_danym_roku > 2
    ) AS zbior_koncowy
    GROUP BY zbior_koncowy.species_id
  ")
liczba_wszystkich_gatunkow_zarejestrowanych_2x_rok_liczba_miejsc_badawczych
```

***

#### Wykład 8 - Ćwiczenie numer 4

Oryginalna treść ćwiczenia:

*"Wyświetl listę miejsc badawczych, w których nie znaleziono żadnych osobników gatunków z rodziny Soricidae."*

Rozwiązanie ćwiczenia:

```{r}
lista_miejsc_badawczych_bez_osobnikow_gatunku_Soricidae <- query_mammals("
  SELECT DISTINCT(pl.plot_type) AS unikalne_miejsca_badawcze_bez_Soricidae
    FROM plots AS pl
    JOIN surveys AS su
    ON pl.plot_id = su.plot_id
    WHERE EXISTS
      (
        SELECT * 
        FROM species AS sp
        WHERE sp.species NOT LIKE 'Soricidae'
      )
  ")
lista_miejsc_badawczych_bez_osobnikow_gatunku_Soricidae
```

***

#### Wykład 8 - Ćwiczenie numer 5

Oryginalna treść ćwiczenia:

*"Wyświetl listę gatunków, które zostały zarejestrowane tylko w miejscach badawczych o numerach 1 lub 2, ale nie zostały zarejestrowane w roku 1999."*

Rozwiązanie ćwiczenia:

```{r}
lista_gatunkow_zarejestrowanych_plots_1_oraz_2_bez_rok_1999 <- query_mammals("
  SELECT DISTINCT(sp.species) AS lista_gatunkow
  FROM species AS sp
  WHERE EXISTS
    (
      SELECT * 
      FROM plots AS pl
      WHERE pl.plot_id = 1 OR pl.plot_id = 2
        AND EXISTS
      (
        SELECT * 
        FROM surveys AS su
        WHERE su.year != 1999
      )
    )
  ")
lista_gatunkow_zarejestrowanych_plots_1_oraz_2_bez_rok_1999
```

***

#### Wykład 8 - Ćwiczenie numer 6

Oryginalna treść ćwiczenia:

*"Wyświetl listę gatunków, które zostały zarejestrowane tylko w roku 1999 lub 2000, razem z liczbą miejsc badawczych, w których zostały zarejestrowane."*

Rozwiązanie ćwiczenia:

```{r}
lista_gatunkow_zarejestrowanych_lata_1999_lub_2000_oraz_miejsca_badawcze <- query_mammals("
  SELECT DISTINCT(sp.species) AS lista_gatunkow, COUNT(plot_id) AS liczba_miejsc_badawczych
  FROM species AS sp
  JOIN surveys AS su
  ON su.species_id = sp.species_id
  WHERE EXISTS
    (
      SELECT * 
        FROM surveys AS su
        WHERE su.year = 1999 OR su.year = 2000
    ) GROUP BY lista_gatunkow
  ")
lista_gatunkow_zarejestrowanych_lata_1999_lub_2000_oraz_miejsca_badawcze
```

***

### Konfiguracja zamykająca

Konfiguracja zamykająca rozwiązania ćwiczeń z wykładów.

```{r}
### Zamykam połączenie z bazą 'mammals'
DBI::dbDisconnect(mammals)
```
***

## Zadania z UPEL

### Konfiguracja wstępna

Poniżej zawarto funkcje pomocniczne do zadań z UPEL.

```{r}
### Ściągam bazę danych lahman_2022
download.file(url = "https://github.com/jknecht/baseball-archive-sqlite/releases/download/2022/lahman_1871-2022.sqlite", destfile = "data_raw/lahman_1871-2022.sqlite", mode = "wb")

### Łączę z bazą danych Lahman
lahman_2022 <- DBI::dbConnect(RSQLite::SQLite(), "data_raw/lahman_1871-2022.sqlite")

### Funkcje pomocnicze

# Funkcja odpytująca bazę danych 'lahman2022'
query_lahman <- function(string_zapytanie_SQL)
{
  DBI::dbGetQuery(lahman_2022, string_zapytanie_SQL)
}
```
***

### Zadanie z UPEL numer 1

Oryginalna treść zadania:

*"Odszukaj nazwiska wszystkich graczy, którzy zostali wprowadzeni do Hall of Fame w pierwszym roku kwalifikowalności, wraz z nazwą drużyny, w której grali w momencie ich wprowadzenia."*

Rozwiązanie ćwiczenia:

```{r}
zadanie_1_UPEL_z_limitem_10_wierszy <- query_lahman("
  SELECT DISTINCT(teams.name) AS nazwa_druzyny, people_to_teams_join.nameLast AS gracz_w_pierwszym_roku_kwalifikowalnosci
  FROM teams
  JOIN 
    ( SELECT playerID, teamID
      FROM batting
    ) AS batting_to_teams_join ON teams.teamID = batting_to_teams_join.teamID
  JOIN
    ( SELECT playerID, namelast
      FROM People
    ) AS people_to_teams_join ON batting_to_teams_join.PlayerID = people_to_teams_join.playerID
  JOIN 
    (
      SELECT playerID, yearID
      FROM HallOfFame
      WHERE inducted = 'Y'
    ) AS hall_of_fame_to_teams_join ON people_to_teams_join.PlayerID = hall_of_fame_to_teams_join.PlayerID
    LIMIT 10
  ")
zadanie_1_UPEL_z_limitem_10_wierszy
```

***

### Zadanie z UPEL numer 2

Oryginalna treść zadania:

*"Dla każdej drużyny w Lidze Narodowej w 2016 roku znajdź nazwiska pięciu najlepszych graczy (na podstawie liczby home runów), którzy grali dla tej drużyny w trakcie sezonu."*

Rozwiązanie ćwiczenia:

```{r}
zadanie_2_UPEL_z_limitem_10_wierszy <- query_lahman("
  SELECT  DISTINCT(people_to_teams_join.namelast) as nazwisko_gracza,
          batting_to_teams_join.hr AS punkty_home_run,
          teams.name as druzyna
  FROM teams
  JOIN
    (SELECT hr, teamID, PlayerID
      FROM batting
      WHERE yearID = 2016
      ORDER BY hr DESC
      LIMIT 5
    ) AS batting_to_teams_join ON teams.hr = batting_to_teams_join.hr
  JOIN 
    (SELECT playerID, namelast
      FROM people
    ) AS people_to_teams_join ON batting_to_teams_join.playerID = people_to_teams_join.playerID
    ORDER BY teams.name
  LIMIT 10
  ")
zadanie_2_UPEL_z_limitem_10_wierszy
```

***

### Zadanie z UPEL numer 3

Oryginalna treść zadania:

*"Odzyskaj nazwiska wszystkich graczy, którzy zostali wymienieni w sezonie 2015 i zagrali w World Series w tym samym roku. Podaj nazwę drużyny, z której zostali wymienieni, drużynę, do której zostali wymienieni, oraz nazwę drużyny, w której grali w World Series."*

Rozwiązanie ćwiczenia:

```{r}
zadanie_3_UPEL_z_limitem_10_wierszy <- query_lahman("
  SELECT DISTINCT(people_to_teams_join.namelast) as nazwiska_wymienionych_graczy, teams.name AS obecna_druzyna, teams_to_franczyza_join.name AS druzyna_z_ktorej_zostali_wymienieni_w_roku_2015
  FROM teams
  JOIN
    (SELECT name, franchID
      FROM teams
      WHERE yearID = 2015
      ) AS teams_to_franczyza_join ON teams.TeamID = teams_to_franczyza_join.franchID
  JOIN 
    ( SELECT playerID, teamID
      FROM batting
    ) AS batting_to_teams_join ON teams.teamID = batting_to_teams_join.teamID
  JOIN
    ( SELECT playerID, namelast
      FROM People
    ) AS people_to_teams_join ON batting_to_teams_join.PlayerID = people_to_teams_join.playerID
  GROUP BY  teams.name
  LIMIT 10
  ")
zadanie_3_UPEL_z_limitem_10_wierszy
```

***

### Zadanie z UPEL numer 4

Oryginalna treść zadania:

*"Odszukaj nazwiska wszystkich graczy, którzy grali w drużynie w dywizji American League East w 2016 r., zdobyli co najmniej 300 uderzeń i zakończyli sezon ze średnią uderzeń powyżej 0,300. Dołącz imię i nazwisko gracza, drużynę i średnią uderzeń."*

Rozwiązanie ćwiczenia:

```{r}
zadanie_4_UPEL_z_limitem_10_wierszy <- query_lahman("
  SELECT  people_to_teams_join.nameFirst AS imie_gracza,
          people_to_teams_join.nameLast AS nazwisko_gracza,
          American_Park_2016_Teams.name AS nazwa_druzyny,
          (SELECT SUM(uderzenia) AS suma_uderzen_do_porownania 
            FROM teams WHERE suma_uderzen_do_porownania > 300) AS suma_uderzen_w_2016_roku,
          (SELECT AVG(uderzenia) AS srednia_uderzen_do_porownania 
            FROM teams WHERE srednia_uderzen_do_porownania > 0.3) AS srednie_uderzenia_w_2016_roku
  FROM
    ( SELECT teamID, yearID, name
      FROM teams
      WHERE park LIKE '%American%' AND yearID = 2016
    ) AS American_Park_2016_Teams
  JOIN 
    ( SELECT playerID, teamID, H AS uderzenia
      FROM batting
    ) AS batting_to_teams_join ON American_Park_2016_Teams.teamID = batting_to_teams_join.teamID
  JOIN
    ( SELECT playerID, nameFirst, nameLast
      FROM People
    ) AS people_to_teams_join ON batting_to_teams_join.PlayerID = people_to_teams_join.playerID
  GROUP BY people_to_teams_join.nameLast
  LIMIT 10
  ")
zadanie_4_UPEL_z_limitem_10_wierszy
```

***

### Konfiguracja zamykająca

Konfiguracja zamykająca rozwiązania zadań z UPEL.

```{r}
### Odłączam bazę danych 'lahman_2022'
DBI::dbDisconnect(lahman_2022)
```

***

## Literatura

[1] - https://lahman.r-forge.r-project.org/doc/

[2] - https://the-examples-book.com/projects/data-sets/Lahman
