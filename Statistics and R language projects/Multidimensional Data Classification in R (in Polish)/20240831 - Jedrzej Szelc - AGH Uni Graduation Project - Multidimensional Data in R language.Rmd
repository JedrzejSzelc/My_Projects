---
title: "Spis treści"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
---

---
title: "Projekt przedmiotu <br /> 'Wielowymiarowa klasyfikacja danych'"
subtitle: "Studia podyplomowe 'Metody Statystycznej Analizy Danych - edycja IX'"
author: "Jędrzej Szelc"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

***

# 1. Wstęp

Celem niniejszego projektu jest zbadanie zależności rocznej liczby zgonów w wyniku przedawkowania opiatów w określonych stanach Stanów Zjednoczonych Ameryki (USA) od wybranych wskaźników makroekeonomicznych. 

Dla każdego z analizowanych stanów USA, zastosowane zostaną te same wskaźniki (miary) makroekonomiczne o właściwych dla danego stanu lokalnych wartościach.

***

## 1.1. Dane

W niniejszym projekcie przeanalizowane zostaną następujące dane panelowe:

* zmienną objaśnianą Y stanowi liczba zgonów z ostatnich dwunastu miesięcy (suma ruchoma) w wyniku przedawkowania opiatów dla danego stanu Stanów Zjednoczonych Ameryki, [1]
* zmienne objaśniające X dla każdego stanu są następujące:
    + X1 - wskaźnik bezrobocia wyrażony w procentach, [2,5,8,11,14],
    + X2 - wskaźnik uczestnictwa w rynku pracy wyrażony w procentach, [3,6,9,12,15],
    + X3 - wskaźnik S&P CoreLogic Case-Shiller dla wybranego miasta danego stanu, [4,7,10,13,16],
* analizowane będą dane dla następujących stanów USA:
    + Waszyngton,
    + Kalifornia,
    + Teksas,
    + Floryda,
    + Nowy Jork.

Wszystkie dane mają przedział czasowy od stycznia 2015 do grudnia 2022 roku włącznie, oraz okres jednego miesiąca kalendarzowego.

Dane panelowe są zbalansowane, przez co rozumiemy, iż dla każdego stanu liczba okresów jest taka sama.

Dodatkowo, wszystkie zmienne objaśniajace X zostały wyrównane sezonowo przez dostawcę danych, czyli System Rezerwy Federalnej Stanów Zjednoczonych.

Odnośniki literaturowe znajdują się w sekcji 7.

***

## 1.2. Konsultacja merytoryczna

W tym miejscu, autor składa podziękowanie Panu Damianowi Kowalskiemu, absolwentowi Uniwersytetu Warszawskiego, za konsultację i wsparcie merytoryczne w dziedzinie statystyki.

***

## 1.3. Wstępna konfiguracja

Wstępna konfiguracja programu R-Studio, w którym zostaną wykonane obliczenia:

```{r}
# Biblioteki:
library("readxl")
library(dplyr)
library(ggplot2)
library(gridExtra)
library(corrplot)
library(GGally)
library(caTools)
library(car)
library(tseries)
library(gplots)
library(plm)
library(lmtest)
# install.packages("devtools")
# devtools::install_github('kkashin/panelAR', force = FALSE)
library(panelAR)

# Wyłączanie warningów (ponowne włączenie warn=0):
options(warn=-1)

# Ścieżka katalogu:
string_sciezka_obecnego_katalogu <- getwd()

# Konfiguracja grafiki:
integer_rozmiar_punktow <- 1
string_kolor_linii <- "steelblue"
integer_rozmiar_czcionki <- 10
string_histogram_fill_colour <- "palegreen3"
string_kolor_czerwony_ogolnie_do_grafiki <- "red"
string_kolor_niebieski_ogolnie_do_grafiki <- "steelblue"
string_kolor_horyzontalnej_linii <- "red"
string_kolor_pionowej_linii <- "red"
string_kolor_linii_regresji_LM <- "red"
string_podpis_osi_liczba_dni_od_01011900 = "Liczba dni od 01.01.1900"
string_podpis_osi_Y = "Zmienna Y"

```

***

# 2. Wstępna analiza danych 

W niniejszej części przeprowadzona zostanie wstępna analiza danych (ang. Initial Data Analysis; IDA).

***

## 2.1. Statystyka danych

```{r}
### Wczytuję dane w formie kolumn:
string_plik_z_danymi_w_formie_kolumn <- "20240819 - WKD - Dane w formie kolumn.xlsx"
df_raw_data <- read_excel(paste0(string_sciezka_obecnego_katalogu,"/Dane_Wejsciowe/",string_plik_z_danymi_w_formie_kolumn))

## Pre-processing danych kolumnowych:

# Zostaw tylko zakres dat od 01.2015 do 12.2022 włącznie:
df_dane_kolumnowe <- df_raw_data %>%
  filter(Year < 2023)

# Kopia bezpieczeństwa oryginalnych danych - na wszelki wypadek:
df_dane_kolumnowe_wyjsciowe <- df_dane_kolumnowe

# Nazwy kolumn df_dane_kolumnowe:
wektor_nazwy_kolumn_df_dane_kolumnowe <- colnames(df_dane_kolumnowe)

# Wstępna IDA:
# str(df_dane_kolumnowe)
summary(df_dane_kolumnowe)
# head(df_dane_kolumnowe)
# tail(df_dane_kolumnowe)

# Pomocnicze rozbicie ramki danych na indywidualne wektory:
wektor_Full_Date <- df_dane_kolumnowe$Full_Date

wektor_Y_Waszyngton <- df_dane_kolumnowe$Y_Waszyngton
wektor_X1_Waszyngton <- df_dane_kolumnowe$X1_Waszyngton
wektor_X2_Waszyngton <- df_dane_kolumnowe$X2_Waszyngton
wektor_X3_Waszyngton <- df_dane_kolumnowe$X3_Waszyngton

wektor_Y_Kalifornia <- df_dane_kolumnowe$Y_Kalifornia
wektor_X1_Kalifornia <- df_dane_kolumnowe$X1_Kalifornia
wektor_X2_Kalifornia <- df_dane_kolumnowe$X2_Kalifornia
wektor_X3_Kalifornia <- df_dane_kolumnowe$X3_Kalifornia

wektor_Y_Teksas <- df_dane_kolumnowe$Y_Teksas
wektor_X1_Teksas <- df_dane_kolumnowe$X1_Teksas
wektor_X2_Teksas <- df_dane_kolumnowe$X2_Teksas
wektor_X3_Teksas <- df_dane_kolumnowe$X3_Teksas

wektor_Y_Floryda <- df_dane_kolumnowe$Y_Floryda
wektor_X1_Floryda <- df_dane_kolumnowe$X1_Floryda
wektor_X2_Floryda <- df_dane_kolumnowe$X2_Floryda
wektor_X3_Floryda <- df_dane_kolumnowe$X3_Floryda

wektor_Y_Nowy_Jork <- df_dane_kolumnowe$Y_Nowy_Jork
wektor_X1_Nowy_Jork <- df_dane_kolumnowe$X1_Nowy_Jork
wektor_X2_Nowy_Jork <- df_dane_kolumnowe$X2_Nowy_Jork
wektor_X3_Nowy_Jork <- df_dane_kolumnowe$X3_Nowy_Jork

### Wczytuję dane w formie panelowej:
string_plik_z_danymi_w_formie_panelowej <- "20240825 - WKD - Dane w formie panelowej.csv"
df_dane_panelowe <-read.csv(paste0(string_sciezka_obecnego_katalogu,"/Dane_Wejsciowe/",string_plik_z_danymi_w_formie_panelowej), sep = ';', dec = '.')

## Pre-processing danych panelowych:
df_dane_panelowe$X1 <- as.numeric(gsub(",", ".", df_dane_panelowe$X1))
df_dane_panelowe$X2 <- as.numeric(gsub(",", ".", df_dane_panelowe$X2))
df_dane_panelowe$X3 <- as.numeric(gsub(",", ".", df_dane_panelowe$X3))
```

***

## 2.2. Wykresy porównawcze Y

Poniżej przedstawiono wykres porównawczy zmiennych Y przy zachowanej skali osi pionowej. 

```{r}
### IDA z wykresami:

# Coplot porównawczy szeregów czasowych zmiennej Y:
coplot(Y ~ Full_Date|State, type="b", data=df_dane_panelowe, rows=1, 
       xlab = string_podpis_osi_liczba_dni_od_01011900, ylab = string_podpis_osi_Y,
       show.given = TRUE)
```

Pozniżej przedstawiono wykres złożeniowy zmiennych Y przy zachowanej skali osi pionowej.
```{r}
# Scatterplot złożeniowy szeregów czasowych zmiennej Y:
scatterplot(Y ~ Full_Date|State, boxplots=FALSE, smooth=TRUE, regLine=FALSE, 
            data=df_dane_panelowe,
            xlab = string_podpis_osi_liczba_dni_od_01011900, 
            ylab = string_podpis_osi_Y)

```

***

## 2.3. Wykresy szeregów czasowych 

Poniżej przedstawiono wykresy wszystkich zmiennych w funkcji czasu (szeregi czasowe).

```{r}

# Wykresy liniowe dla stanu Waszyngton:
obiekt_lineplot_Y_Waszyngton <- ggplot(df_dane_kolumnowe, aes(Full_Date, Y_Waszyngton)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_lineplot_X1_Waszyngton <- ggplot(df_dane_kolumnowe, aes(Full_Date, X1_Waszyngton)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_lineplot_X2_Waszyngton <- ggplot(df_dane_kolumnowe, aes(Full_Date, X2_Waszyngton)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_lineplot_X3_Waszyngton <- ggplot(df_dane_kolumnowe, aes(Full_Date, X3_Waszyngton)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()

obiekt_lineplot_Y_Kalifornia <- ggplot(df_dane_kolumnowe, aes(Full_Date, Y_Kalifornia)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_lineplot_X1_Kalifornia <- ggplot(df_dane_kolumnowe, aes(Full_Date, X1_Kalifornia)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_lineplot_X2_Kalifornia <- ggplot(df_dane_kolumnowe, aes(Full_Date, X2_Kalifornia)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_lineplot_X3_Kalifornia <- ggplot(df_dane_kolumnowe, aes(Full_Date, X3_Kalifornia)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()

obiekt_lineplot_Y_Teksas <- ggplot(df_dane_kolumnowe, aes(Full_Date, Y_Teksas)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_lineplot_X1_Teksas <- ggplot(df_dane_kolumnowe, aes(Full_Date, X1_Teksas)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_lineplot_X2_Teksas <- ggplot(df_dane_kolumnowe, aes(Full_Date, X2_Teksas)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_lineplot_X3_Teksas <- ggplot(df_dane_kolumnowe, aes(Full_Date, X3_Teksas)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()

obiekt_lineplot_Y_Floryda <- ggplot(df_dane_kolumnowe, aes(Full_Date, Y_Floryda)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_lineplot_X1_Floryda <- ggplot(df_dane_kolumnowe, aes(Full_Date, X1_Floryda)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_lineplot_X2_Floryda <- ggplot(df_dane_kolumnowe, aes(Full_Date, X2_Floryda)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_lineplot_X3_Floryda <- ggplot(df_dane_kolumnowe, aes(Full_Date, X3_Floryda)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()

obiekt_lineplot_Y_Nowy_Jork <- ggplot(df_dane_kolumnowe, aes(Full_Date, Y_Nowy_Jork)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_lineplot_X1_Nowy_Jork <- ggplot(df_dane_kolumnowe, aes(Full_Date, X1_Nowy_Jork)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_lineplot_X2_Nowy_Jork <- ggplot(df_dane_kolumnowe, aes(Full_Date, X2_Nowy_Jork)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_lineplot_X3_Nowy_Jork <- ggplot(df_dane_kolumnowe, aes(Full_Date, X3_Nowy_Jork)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()

lista_obiektow_lineplot <- list(obiekt_lineplot_Y_Waszyngton,
                                obiekt_lineplot_X1_Waszyngton,
                                obiekt_lineplot_X2_Waszyngton,
                                obiekt_lineplot_X3_Waszyngton,
                                obiekt_lineplot_Y_Kalifornia,
                                obiekt_lineplot_X1_Kalifornia,
                                obiekt_lineplot_X2_Kalifornia,
                                obiekt_lineplot_X3_Kalifornia,
                                obiekt_lineplot_Y_Teksas,
                                obiekt_lineplot_X1_Teksas,
                                obiekt_lineplot_X2_Teksas,
                                obiekt_lineplot_X3_Teksas,
                                obiekt_lineplot_Y_Floryda,
                                obiekt_lineplot_X1_Floryda,
                                obiekt_lineplot_X2_Floryda,
                                obiekt_lineplot_X3_Floryda,
                                obiekt_lineplot_Y_Nowy_Jork,
                                obiekt_lineplot_X1_Nowy_Jork,
                                obiekt_lineplot_X2_Nowy_Jork,
                                obiekt_lineplot_X3_Nowy_Jork)

grid.arrange(grobs = lista_obiektow_lineplot, ncol = 4, nrow = 5)

```

***

## 2.4. Histogramy

Histogramy wszystkich zmiennych znajdują się poniżej.

```{r}

# Histogramy:
obiekt_histogram_Y_Waszyngton <- ggplot(df_dane_kolumnowe, aes(x=Y_Waszyngton)) + geom_histogram(size = integer_rozmiar_punktow, color = string_kolor_linii, fill = string_histogram_fill_colour) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_histogram_X1_Waszyngton <- ggplot(df_dane_kolumnowe, aes(x=X1_Waszyngton)) + geom_histogram(size = integer_rozmiar_punktow, color = string_kolor_linii, fill = string_histogram_fill_colour) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_histogram_X2_Waszyngton <- ggplot(df_dane_kolumnowe, aes(x=X2_Waszyngton)) + geom_histogram(size = integer_rozmiar_punktow, color = string_kolor_linii, fill = string_histogram_fill_colour) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_histogram_X3_Waszyngton <- ggplot(df_dane_kolumnowe, aes(x=X3_Waszyngton)) + geom_histogram(size = integer_rozmiar_punktow, color = string_kolor_linii, fill = string_histogram_fill_colour) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()

obiekt_histogram_Y_Kalifornia <- ggplot(df_dane_kolumnowe, aes(x=Y_Kalifornia)) + geom_histogram(size = integer_rozmiar_punktow, color = string_kolor_linii, fill = string_histogram_fill_colour) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_histogram_X1_Kalifornia <- ggplot(df_dane_kolumnowe, aes(x=X1_Kalifornia)) + geom_histogram(size = integer_rozmiar_punktow, color = string_kolor_linii, fill = string_histogram_fill_colour) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_histogram_X2_Kalifornia <- ggplot(df_dane_kolumnowe, aes(x=X2_Kalifornia)) + geom_histogram(size = integer_rozmiar_punktow, color = string_kolor_linii, fill = string_histogram_fill_colour) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_histogram_X3_Kalifornia <- ggplot(df_dane_kolumnowe, aes(x=X3_Kalifornia)) + geom_histogram(size = integer_rozmiar_punktow, color = string_kolor_linii, fill = string_histogram_fill_colour) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()

obiekt_histogram_Y_Teksas <- ggplot(df_dane_kolumnowe, aes(x=Y_Teksas)) + geom_histogram(size = integer_rozmiar_punktow, color = string_kolor_linii, fill = string_histogram_fill_colour) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_histogram_X1_Teksas <- ggplot(df_dane_kolumnowe, aes(x=X1_Teksas)) + geom_histogram(size = integer_rozmiar_punktow, color = string_kolor_linii, fill = string_histogram_fill_colour) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_histogram_X2_Teksas <- ggplot(df_dane_kolumnowe, aes(x=X2_Teksas)) + geom_histogram(size = integer_rozmiar_punktow, color = string_kolor_linii, fill = string_histogram_fill_colour) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_histogram_X3_Teksas <- ggplot(df_dane_kolumnowe, aes(x=X3_Teksas)) + geom_histogram(size = integer_rozmiar_punktow, color = string_kolor_linii, fill = string_histogram_fill_colour) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()

obiekt_histogram_Y_Floryda <- ggplot(df_dane_kolumnowe, aes(x=Y_Floryda)) + geom_histogram(size = integer_rozmiar_punktow, color = string_kolor_linii, fill = string_histogram_fill_colour) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_histogram_X1_Floryda <- ggplot(df_dane_kolumnowe, aes(x=X1_Floryda)) + geom_histogram(size = integer_rozmiar_punktow, color = string_kolor_linii, fill = string_histogram_fill_colour) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_histogram_X2_Floryda <- ggplot(df_dane_kolumnowe, aes(x=X2_Floryda)) + geom_histogram(size = integer_rozmiar_punktow, color = string_kolor_linii, fill = string_histogram_fill_colour) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_histogram_X3_Floryda <- ggplot(df_dane_kolumnowe, aes(x=X3_Floryda)) + geom_histogram(size = integer_rozmiar_punktow, color = string_kolor_linii, fill = string_histogram_fill_colour) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()

obiekt_histogram_Y_Nowy_Jork <- ggplot(df_dane_kolumnowe, aes(x=Y_Nowy_Jork)) + geom_histogram(size = integer_rozmiar_punktow, color = string_kolor_linii, fill = string_histogram_fill_colour) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_histogram_X1_Nowy_Jork <- ggplot(df_dane_kolumnowe, aes(x=X1_Nowy_Jork)) + geom_histogram(size = integer_rozmiar_punktow, color = string_kolor_linii, fill = string_histogram_fill_colour) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_histogram_X2_Nowy_Jork <- ggplot(df_dane_kolumnowe, aes(x=X2_Nowy_Jork)) + geom_histogram(size = integer_rozmiar_punktow, color = string_kolor_linii, fill = string_histogram_fill_colour) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_histogram_X3_Nowy_Jork <- ggplot(df_dane_kolumnowe, aes(x=X3_Nowy_Jork)) + geom_histogram(size = integer_rozmiar_punktow, color = string_kolor_linii, fill = string_histogram_fill_colour) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()

lista_obiektow_histogram <- list(obiekt_histogram_Y_Waszyngton,
                                 obiekt_histogram_X1_Waszyngton,
                                 obiekt_histogram_X2_Waszyngton,
                                 obiekt_histogram_X3_Waszyngton,
                                 obiekt_histogram_Y_Kalifornia,
                                 obiekt_histogram_X1_Kalifornia,
                                 obiekt_histogram_X2_Kalifornia,
                                 obiekt_histogram_X3_Kalifornia,
                                 obiekt_histogram_Y_Teksas,
                                 obiekt_histogram_X1_Teksas,
                                 obiekt_histogram_X2_Teksas,
                                 obiekt_histogram_X3_Teksas,
                                 obiekt_histogram_Y_Floryda,
                                 obiekt_histogram_X1_Floryda,
                                 obiekt_histogram_X2_Floryda,
                                 obiekt_histogram_X3_Floryda,
                                 obiekt_histogram_Y_Nowy_Jork,
                                 obiekt_histogram_X1_Nowy_Jork,
                                 obiekt_histogram_X2_Nowy_Jork,
                                 obiekt_histogram_X3_Nowy_Jork)

grid.arrange(grobs = lista_obiektow_histogram, ncol = 4, nrow = 5)


```

***

## 2.5. Wykresy pudełkowe

Poniżej przedstawiono wykresy pudełkowe wszystkich zmiennych.

```{r}

# Wykresy pudełkowe:
obiekt_boxplot_Y_Waszyngton <- ggplot(df_dane_kolumnowe, aes(x=Y_Waszyngton)) + geom_boxplot(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_boxplot_X1_Waszyngton <- ggplot(df_dane_kolumnowe, aes(x=X1_Waszyngton)) + geom_boxplot(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_boxplot_X2_Waszyngton <- ggplot(df_dane_kolumnowe, aes(x=X2_Waszyngton)) + geom_boxplot(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_boxplot_X3_Waszyngton <- ggplot(df_dane_kolumnowe, aes(x=X3_Waszyngton)) + geom_boxplot(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()

obiekt_boxplot_Y_Kalifornia <- ggplot(df_dane_kolumnowe, aes(x=Y_Kalifornia)) + geom_boxplot(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_boxplot_X1_Kalifornia <- ggplot(df_dane_kolumnowe, aes(x=X1_Kalifornia)) + geom_boxplot(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_boxplot_X2_Kalifornia <- ggplot(df_dane_kolumnowe, aes(x=X2_Kalifornia)) + geom_boxplot(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_boxplot_X3_Kalifornia <- ggplot(df_dane_kolumnowe, aes(x=X3_Kalifornia)) + geom_boxplot(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()

obiekt_boxplot_Y_Teksas <- ggplot(df_dane_kolumnowe, aes(x=Y_Teksas)) + geom_boxplot(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_boxplot_X1_Teksas <- ggplot(df_dane_kolumnowe, aes(x=X1_Teksas)) + geom_boxplot(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_boxplot_X2_Teksas <- ggplot(df_dane_kolumnowe, aes(x=X2_Teksas)) + geom_boxplot(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_boxplot_X3_Teksas <- ggplot(df_dane_kolumnowe, aes(x=X3_Teksas)) + geom_boxplot(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()

obiekt_boxplot_Y_Floryda <- ggplot(df_dane_kolumnowe, aes(x=Y_Floryda)) + geom_boxplot(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_boxplot_X1_Floryda <- ggplot(df_dane_kolumnowe, aes(x=X1_Floryda)) + geom_boxplot(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_boxplot_X2_Floryda <- ggplot(df_dane_kolumnowe, aes(x=X2_Floryda)) + geom_boxplot(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_boxplot_X3_Floryda <- ggplot(df_dane_kolumnowe, aes(x=X3_Floryda)) + geom_boxplot(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()

obiekt_boxplot_Y_Nowy_Jork <- ggplot(df_dane_kolumnowe, aes(x=Y_Nowy_Jork)) + geom_boxplot(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_boxplot_X1_Nowy_Jork <- ggplot(df_dane_kolumnowe, aes(x=X1_Nowy_Jork)) + geom_boxplot(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_boxplot_X2_Nowy_Jork <- ggplot(df_dane_kolumnowe, aes(x=X2_Nowy_Jork)) + geom_boxplot(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_boxplot_X3_Nowy_Jork <- ggplot(df_dane_kolumnowe, aes(x=X3_Nowy_Jork)) + geom_boxplot(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()

lista_obiektow_boxplot <- list(obiekt_boxplot_Y_Waszyngton,
                               obiekt_boxplot_X1_Waszyngton,
                               obiekt_boxplot_X2_Waszyngton,
                               obiekt_boxplot_X3_Waszyngton,
                               obiekt_boxplot_Y_Kalifornia,
                               obiekt_boxplot_X1_Kalifornia,
                               obiekt_boxplot_X2_Kalifornia,
                               obiekt_boxplot_X3_Kalifornia,
                               obiekt_boxplot_Y_Teksas,
                               obiekt_boxplot_X1_Teksas,
                               obiekt_boxplot_X2_Teksas,
                               obiekt_boxplot_X3_Teksas,
                               obiekt_boxplot_Y_Floryda,
                               obiekt_boxplot_X1_Floryda,
                               obiekt_boxplot_X2_Floryda,
                               obiekt_boxplot_X3_Floryda,
                               obiekt_boxplot_Y_Nowy_Jork,
                               obiekt_boxplot_X1_Nowy_Jork,
                               obiekt_boxplot_X2_Nowy_Jork,
                               obiekt_boxplot_X3_Nowy_Jork)

grid.arrange(grobs = lista_obiektow_boxplot, ncol = 4, nrow = 5)

```

***

## 2.6. Wykresy rozrzutów 

Poniżej przedstawiono wykresy rozrzutów Y=f(X).

```{r}


# Wykresy Y=f(X) dla wszystkich przekrojów:
obiekt_lineplot_Y_Waszyngton_funkcja_X1 <- ggplot(df_dane_kolumnowe, aes(X1_Waszyngton, Y_Waszyngton)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_lineplot_Y_Waszyngton_funkcja_X2 <- ggplot(df_dane_kolumnowe, aes(X2_Waszyngton, Y_Waszyngton)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_lineplot_Y_Waszyngton_funkcja_X3 <- ggplot(df_dane_kolumnowe, aes(X3_Waszyngton, Y_Waszyngton)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()

obiekt_lineplot_Y_Kalifornia_funkcja_X1 <- ggplot(df_dane_kolumnowe, aes(X1_Kalifornia, Y_Kalifornia)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_lineplot_Y_Kalifornia_funkcja_X2 <- ggplot(df_dane_kolumnowe, aes(X2_Kalifornia, Y_Kalifornia)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_lineplot_Y_Kalifornia_funkcja_X3 <- ggplot(df_dane_kolumnowe, aes(X3_Kalifornia, Y_Kalifornia)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()

obiekt_lineplot_Y_Teksas_funkcja_X1 <- ggplot(df_dane_kolumnowe, aes(X1_Teksas, Y_Teksas)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_lineplot_Y_Teksas_funkcja_X2 <- ggplot(df_dane_kolumnowe, aes(X2_Teksas, Y_Teksas)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_lineplot_Y_Teksas_funkcja_X3 <- ggplot(df_dane_kolumnowe, aes(X3_Teksas, Y_Teksas)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()

obiekt_lineplot_Y_Floryda_funkcja_X1 <- ggplot(df_dane_kolumnowe, aes(X1_Floryda, Y_Floryda)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_lineplot_Y_Floryda_funkcja_X2 <- ggplot(df_dane_kolumnowe, aes(X2_Floryda, Y_Floryda)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_lineplot_Y_Floryda_funkcja_X3 <- ggplot(df_dane_kolumnowe, aes(X3_Floryda, Y_Floryda)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()

obiekt_lineplot_Y_Nowy_Jork_funkcja_X1 <- ggplot(df_dane_kolumnowe, aes(X1_Nowy_Jork, Y_Nowy_Jork)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_lineplot_Y_Nowy_Jork_funkcja_X2 <- ggplot(df_dane_kolumnowe, aes(X2_Nowy_Jork, Y_Nowy_Jork)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()
obiekt_lineplot_Y_Nowy_Jork_funkcja_X3 <- ggplot(df_dane_kolumnowe, aes(X3_Nowy_Jork, Y_Nowy_Jork)) + geom_point(size = integer_rozmiar_punktow, color = string_kolor_linii) + theme(text = element_text(size=integer_rozmiar_czcionki)) + theme_bw()

lista_obiektow_lineplot <- list(obiekt_lineplot_Y_Waszyngton_funkcja_X1,
                                obiekt_lineplot_Y_Waszyngton_funkcja_X2,
                                obiekt_lineplot_Y_Waszyngton_funkcja_X3,
                                obiekt_lineplot_Y_Kalifornia_funkcja_X1,
                                obiekt_lineplot_Y_Kalifornia_funkcja_X2,
                                obiekt_lineplot_Y_Kalifornia_funkcja_X3,
                                obiekt_lineplot_Y_Teksas_funkcja_X1,
                                obiekt_lineplot_Y_Teksas_funkcja_X2,
                                obiekt_lineplot_Y_Teksas_funkcja_X3,
                                obiekt_lineplot_Y_Floryda_funkcja_X1,
                                obiekt_lineplot_Y_Floryda_funkcja_X2,
                                obiekt_lineplot_Y_Floryda_funkcja_X3,
                                obiekt_lineplot_Y_Nowy_Jork_funkcja_X1,
                                obiekt_lineplot_Y_Nowy_Jork_funkcja_X2,
                                obiekt_lineplot_Y_Nowy_Jork_funkcja_X3)
                                
grid.arrange(grobs = lista_obiektow_lineplot, ncol = 3, nrow = 5)

```

***

## 2.7. Efekty ustalone

Poniższe dwa wykresy umożliwiają przeanalizowanie heterogeniczności przekrojów dla zmiennej Y.

```{r}

# Efekty ustalone: heterogeniczność przekrojów
plotmeans(Y ~ df_dane_panelowe$State, main="Heterogeniczność przekrojów", data=df_dane_panelowe,
          bars = TRUE,
          connect = TRUE,
          ccol = "black",
          n.label=FALSE,
          xlab = "Dany stan USA",
          ylab = string_podpis_osi_Y)

# Efekty ustalone: heterogeniczność w wymiarze czasowym 
plotmeans(Y ~ df_dane_panelowe$Full_Date, main="Heterogeniczność przekrojów w wymiarze czasowym", data=df_dane_panelowe,
          xlab = string_podpis_osi_liczba_dni_od_01011900, 
          ylab = string_podpis_osi_Y,
          bars = TRUE,
          n.label=FALSE)
```

***

## 2.8. Podsumowanie sekcji

Każdy z szeregów czasowych wchodzący w skład zbioru analizowanych danych panelowych składa się z 96 próbek (96 miesięcy od stycznia 2015 do grudnia 2022 roku włącznie).

Wykresy porównawcze przedstawione w sekcji 2.2. wskazują, iż roczne liczby zgonów w wyniku przedawkowania opiatów mają charakter wzrostowy we wszystkich pięciu analizowanych stanach USA, choć różni je efekt skali wzrostu (magnituda przyrostu). Widzimy między innymi zbieżność tendencji wzrostowych pomiędzy Teksasem i Waszyngtonem. Tendencje wzrostu liczby zgonów na Florydzie wyraźnie odróżniają się od pozostałych stanów. Widzimy wyraźne różnice w wartościach liczb zgonów pomiędzy pięcioma stanami, co predysponuje te wartości do analizy w formie wielowymiarowej klasyfikacji danych.

Na podstawie wykresów przedstawionych w sekcjach od 2.3. do 2.6. włącznie, czyli analizy wszystkich zmiennych Y oraz X, można stwierdzić, iż pandemia wirusa COVID-19 skutkowała zauważalnym przyrostem liczby zgonów w wyniku przedawkowania opiatów w każdym z analizowanych stanów. Wpływ pandemii jest również wyraźnie zauważalny - choć w wielu przypadkach przejściowy - na wartości zmiennych objaśniających X1 (procentowe wskaźniki bezrobocia dla danego stanu) oraz X2 (procentowe wskaźniki uczestnictwa w rynku pracy w danym stanie) - patrz sekcja 2.3. Wartości wskaźników makroekonomicznych reprezentowanych przez zmienne X2 oraz X3 ucierpiały znacząco, ale tylko tymczasowo i na przestrzeni około 1,5 roku zdołały powrócić do swych przed-pandemicznych poziomów. Wpływ pandemii na zaburzenie (załamanie) wartości zmiennych X2 oraz X3 szczególnie widoczny jest również na histogramach, wykresach pudełkowych oraz rozrzutów względem Y tych dwóch zmiennych (sekcje 2.4.-2.7.). 

***

# 3. Modele LM, FE, RE

W niniejszej sekcji przeprowadzone zostanie dopasowanie modelu regresji łącznej metodą najmniejszych kwadratów (MNK) i sprawdzenie zasadności tego dopasowania wobec alternatywnych modeli FE i RE.

***

## 3.1. Trzy zmienne X

W pierwszej kolejności, modelowanie zostanie przeprowadzone dla wszystkich dostępnych zmiennych objaśniających X, czyli X1, X2 oraz X3.

***

### 3.1.1. Model LM

Modelowanie liniowe (LM) metodą MNK dla trzech zmiennych X daje następujące rezultaty:

```{r}
model_MNK_na_danych_podstawowych <- lm(Y ~ X1+X2+X3, data=df_dane_panelowe)
summary(model_MNK_na_danych_podstawowych)
```

***

### 3.1.2. Model FE

Statystyka modelu FE dla trzech zmiennych jest następująca:

```{r}
model_FE_na_danych_podstawowych <-plm(Y ~ X1+X2+X3, data=df_dane_panelowe, 
                                      index=c("State", "Full_Date"), model="within")
summary(model_FE_na_danych_podstawowych)
```
***

### 3.1.3. Model RE

Statystyka modelu RE dla trzech zmiennych jest następująca:

```{r}
model_RE_na_danych_podstawowych <-plm(Y ~ X1+X2+X3, data=df_dane_panelowe, 
                                      index=c("State", "Full_Date"), model="random")
summary(model_RE_na_danych_podstawowych)
```
***

### 3.1.4. Podsumowanie modeli

Wartość współczynnika R-kwadrat jest, z dokładnością do trzeciego miejsca po przecinku, taka sama dla obydwu modeli panelowych FE i RE oraz dodatkowo znaczenie przewyższa wartość tego współczynnika dla modelu LM.

We wszystkich trzech modelach, zmienna X1 jest nieistotna statystycznie i z tego powodu zostanie usunięta z dalszego modelowania.

***

## 3.2. Dwie zmienne X

Modelowanie zostanie powtórzone z pominięciem zmiennej X1, czyli tylko dla zmiennych X2 oraz X3.

***

### 3.2.1. Model LM

Modelowanie liniowe (LM) metodą MNK dla dwóch zmiennych X daje następujące rezultaty:

```{r}
model_MNK_bez_X1 <- lm(Y ~ X2+X3, data=df_dane_panelowe)
summary(model_MNK_bez_X1)
```

***

### 3.2.2. Model jednokierunkowy FE

Statystyka modelu FE dla dwóch zmiennych jest następująca:

```{r}
model_FE_bez_X1 <-plm(Y ~ X2+X3, data=df_dane_panelowe, 
                      index=c("State", "Full_Date"), model="within")
summary(model_FE_bez_X1)
```
***

### 3.2.3. Model RE

Statystyka modelu RE dla dwóch zmiennych jest następująca:

```{r}
model_RE_bez_X1 <-plm(Y ~ X2+X3, data=df_dane_panelowe, 
                      index=c("State", "Full_Date"), model="random")
summary(model_RE_bez_X1)
```
***

### 3.2.4. Podsumowanie modeli

Na podstawie wartości statystyk modeli z usuniętą zmienną X1, widzimy, że w porównaniu do wyników dla modeli z trzema zmiennymi objaśniającymi X, usunięcie tej zmiennej nie skutkowało pogorszeniem wartości współczynników R-kwadrat w modelach FE i RE.

*** 

## 3.3. Porównanie LM i FE

Jak widać na podstawie poniższych wyników, jednokierunkowy model FE jest preferowany do opisu danych panelowych w porównaniu do zwykłej regresji liniowej (model LM). 

```{r}
fixef(model_FE_bez_X1)
summary(fixef(model_FE_bez_X1, type = "dmean"))
pFtest(model_FE_bez_X1, model_MNK_bez_X1)
```

***

## 3.4. Porównanie FE i RE

Na podstawie przedstawionych poniżej wyników testu Hausmana, którego hipoteza zerowa mówi, iż efekty ustalone są statystycznie nieistotne, stwierdzam, że jednokierunkowy model FE jest preferowany do opisu danych panelowych w porównaniu do jednokierunkowego modelu RE. 

```{r}
phtest(model_FE_bez_X1, model_RE_bez_X1)
```

***

## 3.5. Testy regresji FE

W niniejszej sekcji porównany zostanie między innymi jednokierunkowy model FE z dwukierunkowym modelem FE. Obydwa modele zostaną zbudowane dla dwóch zmiennych objaśniających X2 oraz X3.

***

### 3.5.1. Model jednokierunkowy FE

Statystyka modelu FE dla dwóch zmiennych raz jeszcze:

```{r}
model_FE_bez_X1 <-plm(Y ~ X2+X3, data=df_dane_panelowe, 
                      index=c("State", "Full_Date"), model="within")
summary(model_FE_bez_X1)
```

***

### 3.5.2. Model dwukierunkowy FE

Statystyka dwukierunkowego modelu FE dla dwóch zmiennych X jest następująca:
```{r}
model_FE_bez_X1_dwukierunkowy.time <-plm(Y ~ X2+X3+factor(Full_Date), 
                                         data=df_dane_panelowe, 
                                         index=c("State", "Full_Date"), 
                                         model="within")
summary(model_FE_bez_X1_dwukierunkowy.time)
```

***

### 3.5.3. Model FE - Test Hausmana

Istotność statystyczna efektów czasowych w modelu FE zostanie przebadana przy pomocy testu Hausmana, którego hipoteza zerowa mówi, iż efekty ustalone są nieistotne. Statystyka testu jest następująca:

```{r}
pFtest(model_FE_bez_X1_dwukierunkowy.time, model_FE_bez_X1)
```

Wyniki testu wskazują, że jednokierunkowy model FE jest preferowany w stosunku do dwukierunkowego modelu FE.

***

### 3.5.4. Model FE - Test BP

Istotność statystyczna efektów losowych w dwukierunkowym modelu FE zostanie przebadana przy użyciu testu Breuscha-Pagana (BP), którego hipoteza zerowa mówi, iż efekty losowe są nieistotne. Statystyka testu jest następująca:

```{r}
plmtest(model_FE_bez_X1, c("time"), type=("bp"))
```

Na podstawie testu widzimy, iż czynnik czasowy jest statystycznie istotny w modelu jednokierunkowym.

***

### 3.5.5 Podsumowanie testów FE

Na podstawie wykonanych testów statystycznych stwierdzam, iż dla regresji FE brak jest podstaw do odrzucenia hipotez zerowych testów Hausmana oraz Breuscha-Pagana. Brak jest podstaw do stwierdzenia, iż w dwukierunkowym modelu FE występują istotne statystycznie efekty czasowe (ustalone) lub losowe. Jednocześnie, czynnik czasowy (ustalony) jest statystycznie istotny w jednokierunkowym modelu FE.

Jednokierunkowy model FE jest preferowany w stosunku do dwukierunkowego modelu FE.

***

## 3.6. Testy regresji RE

***

### 3.6.1. Model RE

Regresja łączna RE ma następującą postać:

```{r}
model_RE_pooling_bez_X1 <-plm(Y ~ X2+X3, data=df_dane_panelowe, 
                              index=c("State", "Full_Date"), model="pooling")
summary(model_RE_pooling_bez_X1)
```

***

### 3.6.2. Model RE - Test BP

Istotność statystyczna efektów losowych w modelu RE zostanie przebadana przy użyciu testu Breuscha-Pagana. 
Statystyka testu jest następująca:

```{r}
plmtest(model_RE_pooling_bez_X1, type=c("bp"))
```

Na podstawie testu widzimy, iż czynnik czasowy jest statystycznie istotny w modelu RE.

***

### 3.6.3. Model RE - Test Hausmana

Przy pomocy testu Hausmana porównamy ze sobą jednokierunkowy model FE z modelem RE. 
Statystyka testu jest następująca:

```{r}
pFtest(model_FE_bez_X1, model_RE_pooling_bez_X1)
```

W teście uzyskano wartość p < 0,001, a co za tym idzie odrzucam hipotezę zerową testu na rzecz hipotezy alternatywnej, która mówi, iż w modelu istnieją statystycznie istotne efekty ustalone. Tym samym, jednokierunkowy model FE jest preferowany w stosunku do regresji łącznej (model RE).

***

### 3.6.4 Podsumowanie testów RE

Podsumowując, przeprowadzone testy selekcyjne wskazują na wybór jednokierunkowego modelu FE.

***

## 3.7. Podsumowanie sekcji

Jednokierunkowy model FE zostaje skierowany do dalszej analizy. Przetestowane zostaną heteroskedastyczność i autokorelacja tego modelu. 

***

# 4. Testy modelu FE

W niniejszej sekcji, jednokierunkowy model FE zostanie przetestowany pod kątem występowania w nim heteroskedastyczności oraz autokorelacji.

***

## 4.1. Autokorelacja

Przy użyciu testu Breuscha-Godfrey'a/Wooldrige'a przetestowano autokorelację wewnątrzgrupową 1. rzędu. Hipoteza zerowa wyżej wymienionego testu mówi, iż nie występuje korelacja do danego rzędu włącznie. Statystyka testu jest następująca:

```{r}
pbgtest(model_FE_bez_X1, order=1)
```

Wyniki testu wskazują, iż są podstawy do odrzucenia hipotezy zerowej. Innymi słowy, istnieją podstawy do stwierdzenia, iż autokorelacja występuje w jednokierunkowym modelu FE.

***

## 4.2. Heteroskedastyczność

Ewentualne występowanie heteroskedastyczności w jednokierunkowym modelu FE zostanie przetestowane przy użyciu testu Breuscha-Pagana w dwóch wariantach. Hipoteza zerowa obydwu tych testów mówi, iż w modelu występuje homoskedastyczność (brak jest heteroskedastyczności).
Statystyka testu jest następująca:

```{r}
bptest(Y ~ X2+X3, data=df_dane_panelowe,  studentize=T)
bptest(Y ~ X2+X3, data=df_dane_panelowe,  studentize=F)
```

Obydwa warianty testu sugerują występowanie heteroskedastyczności w jednokierunkowym modelu FE.

***

## 4.3. Podsumowanie sekcji

W modelu stwierdzono istotnie statystyczne autokorelację oraz heteroskedastyczność.

***

# 5. Korekta modelu FE

Ze względu na wykrycie w modelu istotnych statystycznie autokorelacji oraz heteroskedastyczności, decydujemy się na zastosowanie dwóch wariantów korekty. 

Korekty zostaną zrealizowane przy pomocy zewnętrznej biblioteki `panelAR', [17]. 

Pakiet ten umożliwia:

* tylko korektę autokorelacji,
* jednoczesną korektę autokorelacji oraz heteroskedastyczności.

***

## 5.1. Tylko autokorelacja

Przy użyciu pakietu `panelAR' w modelu zostanie skorygowana tylko autokorelacja.
Dodatkowo przeprowadzony zostanie test Hausmana.

```{r}
model_tylko_z_korekta_autokorelacji <- panelAR(Y ~ X2+X3, 
                                      data=df_dane_panelowe,
                                      panelVar='State',
                                      timeVar='Full_Date',
                                      autoCorr='psar1',
                                      panelCorrMethod='none',
                                      rhotype = "theil")
summary(model_tylko_z_korekta_autokorelacji)

roznice_wspolczynnikow <- 
  model_tylko_z_korekta_autokorelacji$coefficients - model_RE_bez_X1$coefficients
roznice_V <- 
  model_tylko_z_korekta_autokorelacji$vcov-model_RE_bez_X1$vcov

nowa_statystyka_hausmana <- 
  abs(t(roznice_wspolczynnikow)%*%solve(roznice_V)%*%roznice_wspolczynnikow)
nowa_statystyka_hausmana

nowa_p_wartosc <- 1-pchisq(abs(nowa_statystyka_hausmana), 2)
nowa_p_wartosc
```

***

## 5.2. Podwójna korekta

W niniejszej podsekcji przeprowadzona zostanie jednoczesna korekta autokorelacji oraz heteroskedastyczności.
Podobnie jak wcześniej, po korektach przeprowadzony zostanie również test Hausmana.

```{r}
model_z_korekta_autokorelacji_i_heteroskedastycznosci <- panelAR(Y ~ X2+X3, 
                                                                 data=df_dane_panelowe, 
                                                                 panelVar='State', 
                                                                 timeVar='Full_Date', 
                                                                 autoCorr='psar1', 
                                                                 panelCorrMethod='pcse', 
                                                                 rhotype = "theil")
summary(model_z_korekta_autokorelacji_i_heteroskedastycznosci)

roznice_wspolczynnikow <- 
  model_z_korekta_autokorelacji_i_heteroskedastycznosci$coefficients-model_RE_bez_X1$coefficients
roznice_V <- 
  model_z_korekta_autokorelacji_i_heteroskedastycznosci$vcov-model_RE_bez_X1$vcov

nowa_statystyka_hausmana <- 
  abs(t(roznice_wspolczynnikow)%*%solve(roznice_V)%*%roznice_wspolczynnikow)
nowa_statystyka_hausmana

nowa_p_wartosc <- 1-pchisq(abs(nowa_statystyka_hausmana), 2)
nowa_p_wartosc

```

***

## 5.3. Podsumowanie sekcji

Bez względu na wybrany schemat korekty, najlepszym z modeli jest jednokierunkowy model FE z dwoma istotnymi zmiennymi X.
Do ostatecznej interpretacji powinniśmy wybrać współczynniki skorygowanego modelu FE, ponieważ tego typu model:

* ma skorygowaną autokorelację oraz heteroskedastyczność, które występują w podstawowym modelu FE,
* jest właściwszy do testu Hausmana.

***

# 6. Podsumowanie

Ostateczna interpretacja jednokierunkowego modelu FE jest następująca:

* wzrost wartości zmiennej X2 o jednostkę powoduje spadek wartości zmiennej Y o -41,412,
* wzrost wartości zmiennej X3 o jednostkę powoduje wzrost wartości zmiennej Y o +21,161.

Dopasowanie modelu jest na akceptowalnym poziomie i jego wartość wynosi R-kwadrat = 72,41%. Ogólnie, modelowanie należy uznać za bardziej udane, niż to w projekcie Analizy Współzależności Zjawisk.

```{r}
summary(model_z_korekta_autokorelacji_i_heteroskedastycznosci)
```

***

# 7. Literatura
[1] - https://data.cdc.gov/NCHS/VSRR-Provisional-Drug-Overdose-Death-Counts/xkb8-kh2a/about_data 

[2] - https://fred.stlouisfed.org/series/WAUR

[3] - https://fred.stlouisfed.org/series/LBSSA53

[4] - https://fred.stlouisfed.org/series/SEXRSA

[5] - https://fred.stlouisfed.org/series/CAUR

[6] - https://fred.stlouisfed.org/series/LBSSA06

[7] - https://fred.stlouisfed.org/series/SFXRSA

[8] - https://fred.stlouisfed.org/series/TXUR

[9] - https://fred.stlouisfed.org/series/LBSSA48

[10] - https://fred.stlouisfed.org/series/DAXRSA

[11] - https://fred.stlouisfed.org/series/FLUR

[12] - https://fred.stlouisfed.org/series/LBSSA12

[13] - https://fred.stlouisfed.org/series/MIXRSA

[14] - https://fred.stlouisfed.org/series/NYUR

[15] - https://fred.stlouisfed.org/series/LBSSA36

[16] - https://fred.stlouisfed.org/series/NYXRSA

[17] - https://github.com/kkashin/panelAR